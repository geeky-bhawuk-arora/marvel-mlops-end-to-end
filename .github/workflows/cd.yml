name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build wheel
        run: |
          uv build
          test -f dist/*.whl

      - name: Increment version
        id: version
        run: |
          VERSION=$(cat version.txt 2>/dev/null || echo v1)
          NUM=${VERSION#v}
          NEW_VERSION="v$((NUM + 1))"
          echo "$NEW_VERSION" > version.txt
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit version
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add version.txt
          git commit -m "chore: bump version to $(cat version.txt)"
          git push


  deploy-dev:
    needs: build-and-version
    runs-on: ubuntu-latest
    environment: dev

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.PAT }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy DEV
        env:
          DATABRICKS_BUNDLE_ENV: dev
        run: |
          databricks bundle deploy \
            --var="version=$VERSION" \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}"


  deploy-acc:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: acc

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.PAT }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy ACC
        env:
          DATABRICKS_BUNDLE_ENV: acc
        run: databricks bundle deploy --var="version=$VERSION"


  deploy-prd:
    needs: deploy-acc
    runs-on: ubuntu-latest
    environment: prd

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.PAT }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy PRD
        env:
          DATABRICKS_BUNDLE_ENV: prd
        run: databricks bundle deploy --var="version=$VERSION"
