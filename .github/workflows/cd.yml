name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - 'main'

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: write
    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0
        with:
          version: 0.246.0

      - name: Configure Databricks CLI
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [default]
          host = ${{ vars.DATABRICKS_HOST }}
          client_id = ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          EOF

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build Python wheel
        run: |
          uv build
          ls -lh dist/
          if [ ! -f dist/*.whl ]; then
            echo "❌ UV build failed: no .whl file found"
            exit 1
          fi

      - name: Get Current Version
        run: |
          if [ -f version.txt ]; then
            VERSION=$(cat version.txt)
            echo "Current version: $VERSION"
          else
            VERSION="v1"
            echo "No version file found, starting at $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Increment Version
        run: |
          VERSION_NUMBER=$(echo $VERSION | sed 's/v//')
          NEW_VERSION_NUMBER=$((VERSION_NUMBER + 1))
          NEW_VERSION="v$NEW_VERSION_NUMBER"
          echo "New version: $NEW_VERSION"
          echo $NEW_VERSION > version.txt
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Debug Version
        run: echo "VERSION is: $VERSION"

      - name: Deploy to DEV
        env:
          DATABRICKS_BUNDLE_ENV: dev
        run: |
          echo "Deploying bundle to DEV..."
          databricks bundle deploy \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}" \
            --var="version=$VERSION"

      - name: Verify DEV deploy
        run: |
          echo "Listing DEV bundle files in workspace:"
          databricks workspace ls /Workspace/Users/${USER}/.bundle/dev/marvel-characters/files || echo "No files found"


  deploy-acc:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: acc
    permissions:
      contents: write
    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0
        with:
          version: 0.246.0

      - name: Configure Databricks CLI
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [default]
          host = ${{ vars.DATABRICKS_HOST }}
          client_id = ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          EOF

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build Python wheel for ACC
        run: |
          uv build
          ls -lh dist/
          if [ ! -f dist/*.whl ]; then
            echo "❌ UV build failed: no .whl file found"
            exit 1
          fi

      - name: Ensure ACC folder exists
        run: |
          databricks workspace mkdirs /Workspace/Shared/.bundle/acc/marvel-characters
          databricks workspace ls /Workspace/Shared/.bundle/acc || echo "Folder ready"

      - name: Deploy to ACC
        env:
          DATABRICKS_BUNDLE_ENV: acc
        run: |
          echo "Deploying bundle to ACC..."
          databricks bundle deploy \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}" \
            --var="version=$VERSION"

      - name: Verify ACC deploy
        run: |
          echo "Listing ACC bundle files in workspace:"
          databricks workspace ls /Workspace/Shared/.bundle/acc/marvel-characters/files || echo "No files found"


  deploy-prd:
    runs-on: ubuntu-latest
    needs: deploy-acc
    environment: prd
    permissions:
      contents: write
    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0
        with:
          version: 0.246.0

      - name: Configure Databricks CLI
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [default]
          host = ${{ vars.DATABRICKS_HOST }}
          client_id = ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          EOF

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build Python wheel for PRD
        run: |
          uv build
          ls -lh dist/
          if [ ! -f dist/*.whl ]; then
            echo "❌ UV build failed: no .whl file found"
            exit 1
          fi

      - name: Deploy to PRD
        env:
          DATABRICKS_BUNDLE_ENV: prd
        run: |
          echo "Deploying bundle to PRD..."
          databricks bundle deploy \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}" \
            --var="version=$VERSION"

      - name: Verify PRD deploy
        run: |
          echo "Listing PRD bundle files in workspace:"
          databricks workspace ls /Workspace/Shared/.bundle/prd/marvel-characters/files || echo "No files found"
