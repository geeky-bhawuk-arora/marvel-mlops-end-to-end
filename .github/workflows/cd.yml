name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Increment versions (deploy + python)
        id: version
        run: |
          RAW_VERSION=$(cat version.txt 2>/dev/null || echo v1)
          RAW_VERSION=$(echo "$RAW_VERSION" | tr -d '\n' | tr -d '\r')

          NUM=${RAW_VERSION#v}
          NEW_NUM=$((NUM + 1))

          DEPLOY_VERSION="v$NEW_NUM"
          PY_VERSION="$NEW_NUM.0.0"

          echo "$DEPLOY_VERSION" > version.txt
          echo "$PY_VERSION" > py_version.txt

          echo "version=$DEPLOY_VERSION" >> $GITHUB_OUTPUT

          echo "Deploy version: $DEPLOY_VERSION"
          echo "Python version: $PY_VERSION"

      - name: Build Python wheel
        run: |
          uv build
          ls -lh dist/
          test -f dist/*.whl

      - name: Commit version files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add version.txt py_version.txt
          git commit -m "chore: bump version to $(cat version.txt)"
          git push


  deploy-dev:
    needs: build-and-version
    runs-on: ubuntu-latest
    environment: dev

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy DEV
        env:
          DATABRICKS_BUNDLE_ENV: dev
        run: |
          databricks bundle deploy \
            --var="version=$VERSION" \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}"


  deploy-acc:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: acc

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy ACC
        env:
          DATABRICKS_BUNDLE_ENV: acc
        run: |
          databricks bundle deploy \
            --var="version=$VERSION"


  deploy-prd:
    needs: deploy-acc
    runs-on: ubuntu-latest
    environment: prd

    env:
      VERSION: ${{ needs.build-and-version.outputs.version }}
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: databricks/setup-cli@v0.246.0

      - name: Deploy PRD
        env:
          DATABRICKS_BUNDLE_ENV: prd
        run: |
          databricks bundle deploy \
            --var="version=$VERSION"
