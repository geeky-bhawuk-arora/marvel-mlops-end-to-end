name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - 'main'

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: write
    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0
        with:
          version: 0.246.0

      - name: Configure Databricks CLI
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [default]
          host = ${{ vars.DATABRICKS_HOST }}
          client_id = ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          EOF

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build Python wheel
        run: |
          uv build
          # Verify the wheel exists
          ls -lh dist/
          if [ ! -f dist/*.whl ]; then
            echo "❌ UV build failed: no .whl file found"
            exit 1
          fi

      - name: Deploy to DEV
        env:
          DATABRICKS_BUNDLE_ENV: dev
        run: |
          echo "Deploying bundle to DEV..."
          databricks bundle deploy \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}"

      - name: Verify DEV deploy
        run: |
          echo "Listing DEV bundle files in workspace:"
          databricks workspace ls /Workspace/Users/${USER}/.bundle/dev/marvel-characters/files || echo "No files found"

  deploy-acc:
    runs-on: ubuntu-latest
    needs: deploy-dev  # Only runs if DEV deploy succeeds
    environment: acc
    permissions:
      contents: write
    env:
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@v0.246.0
        with:
          version: 0.246.0

      - name: Configure Databricks CLI
        run: |
          mkdir -p ~/.databricks
          cat > ~/.databrickscfg << EOF
          [default]
          host = ${{ vars.DATABRICKS_HOST }}
          client_id = ${{ secrets.DATABRICKS_CLIENT_ID }}
          client_secret = ${{ secrets.DATABRICKS_CLIENT_SECRET }}
          EOF

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Build Python wheel for ACC
        run: |
          uv build
          # Verify the wheel exists
          ls -lh dist/
          if [ ! -f dist/*.whl ]; then
            echo "❌ UV build failed: no .whl file found"
            exit 1
          fi

      - name: Ensure ACC folder exists
        run: |
          databricks workspace mkdirs /Workspace/Users/${USER}/.bundle/acc/marvel-characters
          databricks workspace ls /Workspace/Users/${USER}/.bundle/acc || echo "Folder ready"

      - name: Deploy to ACC
        env:
          DATABRICKS_BUNDLE_ENV: acc
        run: |
          echo "Deploying bundle to ACC..."
          databricks bundle deploy \
            --var="git_sha=${{ github.sha }}" \
            --var="branch=${{ github.ref_name }}"

      - name: Verify ACC deploy
        run: |
          echo "Listing ACC bundle files in workspace:"
          databricks workspace ls /Workspace/Users/${USER}/.bundle/acc/marvel-characters/files || echo "No files found"

      - name: Tag version for ACC
        run: |
          VERSION=$(cat version.txt)
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            git tag "$VERSION"
            git push origin "$VERSION"
          else
            echo "Tag $VERSION already exists, skipping"
